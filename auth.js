// Sistema de Autentica√ß√£o CEDESP
class AuthSystem {
  constructor() {
    this.users = {
      "prof.programacao": {
        password: "prog123",
        role: "professor",
        course: "programacao",
        name: "Prof. Programa√ß√£o",
        courses: ["PWT", "PWN"], // Programa√ß√£o Web Tarde e Noite
        avatar: "üë®‚Äçüíª",
      },
      "prof.design": {
        password: "design123",
        role: "professor",
        course: "design",
        name: "Prof. Design Gr√°fico",
        courses: ["DGT", "DGN"], // Design Gr√°fico Tarde e Noite
        avatar: "üé®",
      },
      "prof.manicure": {
        password: "mani123",
        role: "professor",
        course: "manicure",
        name: "Prof. Manicure",
        courses: ["MNT", "MNN"], // Manicure Tarde e Noite
        avatar: "üíÖ",
      },
      "prof.mundotrabalho": {
        password: "mundo123",
        role: "professor",
        course: "mundotrabalho",
        name: "Prof. Mundo do Trabalho",
        courses: ["PWT", "PWN", "DGT", "DGN", "MNT", "MNN"], // Acesso a todas as turmas
        avatar: "üåç",
      },
      "prof.convivio": {
        password: "convivio123",
        role: "professor",
        course: "convivio",
        name: "Prof. Conv√≠vio",
        courses: ["PWT", "PWN", "DGT", "DGN", "MNT", "MNN"], // Acesso a todas as turmas
        avatar: "ü§ù",
      },
      admin: {
        password: "admin123",
        role: "admin",
        course: "all",
        name: "Administrador",
        courses: ["PWT", "PWN", "DGT", "DGN", "MNT", "MNN"],
        avatar: "‚öôÔ∏è",
      },
    };

    this.currentUser = null;
    this.init();
  }

  init() {
    // Verificar se j√° est√° logado
    this.checkExistingSession();

    // S√≥ configurar event listeners se estivermos na p√°gina de login
    if (window.location.pathname.endsWith("login.html")) {
      this.setupLoginPageElements();
    }
  }

  setupLoginPageElements() {
    // Event listeners
    const loginForm = document.getElementById("loginForm");
    if (loginForm) {
      loginForm.addEventListener("submit", (e) => this.handleLogin(e));
    }

    // Auto-complete dos usu√°rios de teste
    this.setupTestUserCards();

    // Modal de notifica√ß√£o
    this.setupNotificationModal();
  }

  checkExistingSession() {
    console.log("üîç Verificando sess√£o existente...");
    console.log("üìç P√°gina atual:", window.location.pathname);

    const savedUser = localStorage.getItem("cedesp_user");
    if (savedUser) {
      try {
        this.currentUser = JSON.parse(savedUser);
        console.log("‚úÖ Sess√£o encontrada:", this.currentUser.name);

        // S√≥ redirecionar se estivermos na p√°gina de login
        if (
          window.location.pathname.endsWith("login.html") ||
          window.location.pathname.endsWith("/") ||
          window.location.pathname === "/"
        ) {
          console.log("üîÑ Redirecionando da p√°gina de login...");
          this.redirectToMainApp();
        } else {
          console.log("‚úÖ J√° na p√°gina correta, n√£o redirecionando");
        }
      } catch (e) {
        console.error("‚ùå Erro ao carregar sess√£o:", e);
        localStorage.removeItem("cedesp_user");
      }
    } else {
      console.log("‚ùå Nenhuma sess√£o encontrada");
    }
  }

  setupTestUserCards() {
    const userCards = document.querySelectorAll(".user-card");
    if (userCards.length > 0) {
      userCards.forEach((card) => {
        card.addEventListener("click", () => {
          const username = this.extractUsernameFromCard(card);
          if (username) {
            const usernameInput = document.getElementById("username");
            const passwordInput = document.getElementById("password");
            if (usernameInput && passwordInput) {
              usernameInput.value = username;
              passwordInput.focus();
            }
          }
        });
      });
    }
  }

  extractUsernameFromCard(card) {
    const codeElement = card.querySelector("code");
    if (
      codeElement &&
      codeElement.previousElementSibling?.textContent.includes("Usu√°rio:")
    ) {
      return codeElement.textContent;
    }
    return null;
  }

  setupNotificationModal() {
    const notificationOkBtn = document.getElementById("notificationOkBtn");
    if (notificationOkBtn) {
      notificationOkBtn.addEventListener("click", () => {
        this.hideNotification();
      });
    }
  }

  async handleLogin(e) {
    e.preventDefault();

    const username = document.getElementById("username").value.trim();
    const password = document.getElementById("password").value;

    if (!username || !password) {
      this.showNotification(
        "error",
        "Campos Obrigat√≥rios",
        "Por favor, preencha usu√°rio e senha."
      );
      return;
    }

    this.showLoading();

    // Simular delay de autentica√ß√£o
    await this.delay(1500);

    const isValid = this.validateCredentials(username, password);

    this.hideLoading();

    if (isValid) {
      this.currentUser = {
        username,
        ...this.users[username],
        loginTime: new Date().toISOString(),
      };

      // Salvar sess√£o
      localStorage.setItem("cedesp_user", JSON.stringify(this.currentUser));

      this.showNotification(
        "success",
        "Login Realizado!",
        `Bem-vindo(a), ${this.currentUser.name}! Redirecionando...`
      );

      // Redirecionar ap√≥s um tempo
      setTimeout(() => {
        this.redirectToMainApp();
      }, 2000);
    } else {
      this.showNotification(
        "error",
        "Acesso Negado",
        "Usu√°rio ou senha incorretos. Verifique suas credenciais."
      );
    }
  }

  validateCredentials(username, password) {
    const user = this.users[username];
    return user && user.password === password;
  }

  redirectToMainApp() {
    // Verificar se j√° estamos na p√°gina principal para evitar loop
    if (
      window.location.pathname.endsWith("index.html") ||
      (!window.location.pathname.endsWith("login.html") &&
        !window.location.pathname.endsWith("stats.html"))
    ) {
      console.log("üîÑ J√° na p√°gina principal, n√£o redirecionando");
      return;
    }

    // Adicionar par√¢metros de usu√°rio √† URL
    const params = new URLSearchParams({
      user: this.currentUser.username,
      role: this.currentUser.role,
      course: this.currentUser.course,
    });

    console.log("üîÑ Redirecionando para p√°gina principal...");
    window.location.href = `index.html?${params.toString()}`;
  }

  showLoading() {
    const loadingOverlay = document.getElementById("loadingOverlay");
    const loginBtn = document.getElementById("loginBtn");

    if (loadingOverlay) {
      loadingOverlay.classList.add("active");
    }
    if (loginBtn) {
      loginBtn.classList.add("loading");
      loginBtn.disabled = true;
    }
  }

  hideLoading() {
    const loadingOverlay = document.getElementById("loadingOverlay");
    const loginBtn = document.getElementById("loginBtn");

    if (loadingOverlay) {
      loadingOverlay.classList.remove("active");
    }
    if (loginBtn) {
      loginBtn.classList.remove("loading");
      loginBtn.disabled = false;
    }
  }

  showNotification(type, title, message) {
    const modal = document.getElementById("notificationModal");
    const icon = document.getElementById("notificationIcon");
    const iconSymbol = document.getElementById("notificationIconSymbol");
    const titleEl = document.getElementById("notificationTitle");
    const messageEl = document.getElementById("notificationMessage");

    // Limpar classes anteriores
    icon.className = "notification-icon";

    // Definir √≠cone e classe baseado no tipo
    switch (type) {
      case "success":
        icon.classList.add("success");
        iconSymbol.textContent = "‚úì";
        break;
      case "error":
        icon.classList.add("error");
        iconSymbol.textContent = "‚úï";
        break;
      case "warning":
        icon.classList.add("warning");
        iconSymbol.textContent = "‚ö†";
        break;
      default:
        icon.classList.add("info");
        iconSymbol.textContent = "‚Ñπ";
    }

    titleEl.textContent = title;
    messageEl.textContent = message;
    modal.classList.add("active");
  }

  hideNotification() {
    const modal = document.getElementById("notificationModal");
    modal.classList.remove("active");
  }

  delay(ms) {
    return new Promise((resolve) => setTimeout(resolve, ms));
  }

  // M√©todo est√°tico para verificar se o usu√°rio est√° logado
  static getCurrentUser() {
    const savedUser = localStorage.getItem("cedesp_user");
    if (savedUser) {
      try {
        return JSON.parse(savedUser);
      } catch (e) {
        localStorage.removeItem("cedesp_user");
        return null;
      }
    }
    return null;
  }

  // M√©todo est√°tico para fazer logout
  static logout() {
    console.log("üîì Fazendo logout...");
    localStorage.removeItem("cedesp_user");
    window.location.href = "login.html";
  }

  // M√©todo para limpar dados em caso de erro
  static clearSession() {
    console.log("üßπ Limpando sess√£o...");
    localStorage.removeItem("cedesp_user");
  }

  // M√©todo para verificar permiss√µes
  static hasPermission(requiredRole, userRole = null) {
    const currentUser = userRole
      ? { role: userRole }
      : AuthSystem.getCurrentUser();
    if (!currentUser) return false;

    if (currentUser.role === "admin") return true;
    if (requiredRole === "professor" && currentUser.role === "professor")
      return true;

    return false;
  }

  // M√©todo para filtrar alunos baseado no usu√°rio logado
  static filterStudentsByUser(students, user = null) {
    const currentUser = user || AuthSystem.getCurrentUser();
    if (!currentUser) return [];

    console.log(
      "üîç Filtrando alunos para:",
      currentUser.name,
      "Role:",
      currentUser.role
    );

    // Admin tem acesso a todos os alunos
    if (currentUser.role === "admin") {
      console.log("üëë Admin - acesso total a", students.length, "alunos");
      return students;
    }

    // Professor s√≥ v√™ alunos de seus cursos
    if (currentUser.role === "professor") {
      const filteredStudents = students.filter((student) =>
        currentUser.courses.includes(student.Origem)
      );
      console.log(
        "üë®‚Äçüè´ Professor",
        currentUser.name,
        "- cursos:",
        currentUser.courses
      );
      console.log(
        "üìö Alunos filtrados:",
        filteredStudents.length,
        "de",
        students.length,
        "total"
      );
      return filteredStudents;
    }

    return [];
  }
}

// Inicializar o sistema de autentica√ß√£o quando a p√°gina carregar
document.addEventListener("DOMContentLoaded", () => {
  new AuthSystem();
});

// Exportar para uso global
window.AuthSystem = AuthSystem;
